---
import DataLayout from '../../layouts/DataLayout.astro';
import energyData from '../../data/energy-prices.json';
import { getEnergyPriceStats } from '../../lib/energy-prices';

const sources = energyData.metadata.sources;
const lastUpdated = new Date(energyData.metadata.lastUpdated);
const stats = getEnergyPriceStats(energyData);
const basePoint = energyData.timeSeries.find((point) => point.year === stats.baseYear) ?? energyData.timeSeries[0];

const formatPercent = (value: number) => `${value >= 0 ? '+' : ''}${Math.round(value)}%`;
const euChange = formatPercent(stats.changes.europe);
const usChange = formatPercent(stats.changes.usa);
const ratioDisplay = stats.ratio.toFixed(1);
const baseRatio = basePoint?.usa ? basePoint.europe / basePoint.usa : 0;
const baseRatioDisplay = baseRatio.toFixed(1);
---

<DataLayout
  title="Industrial Electricity Prices"
  description="Track the growing gap between European energy costs and global competitors. Updated monthly with data from Eurostat, EIA, and IEA."
  lastUpdated={lastUpdated}
  sources={sources}
>
  <!-- Key stats -->
  <div class="grid md:grid-cols-4 gap-6 mb-12">
    <div class="stat">
      <p class="stat-value">€{Math.round(stats.latest.europe)}</p>
      <p class="stat-label">EU Average ({stats.latest.year})</p>
      <p class="text-xs text-ink-400 mt-2">{euChange} vs {stats.baseYear}</p>
    </div>
    <div class="stat">
      <p class="stat-value">€{Math.round(stats.latest.usa)}</p>
      <p class="stat-label">US Average ({stats.latest.year})</p>
      <p class="text-xs text-ink-400 mt-2">{usChange} vs {stats.baseYear}</p>
    </div>
    <div class="stat">
      <p class="stat-value">{ratioDisplay}×</p>
      <p class="stat-label">EU/US Price Ratio</p>
      <p class="text-xs text-ink-400 mt-2">Up from {baseRatioDisplay}× in {stats.baseYear}</p>
    </div>
    <div class="stat">
      <p class="stat-value">€{Math.round(stats.premium)}</p>
      <p class="stat-label">EU Premium vs US</p>
      <p class="text-xs text-ink-400 mt-2">Per MWh</p>
    </div>
  </div>

  <!-- Main comparison chart -->
  <div class="mb-12">
    <h2 class="text-display-sm mb-4">Price Comparison: Europe vs. US vs. China (2008-{stats.latest.year})</h2>
    <p class="text-ink-600 mb-6 max-w-2xl">EU industrial electricity prices have diverged sharply from competitors, especially since 2021.</p>
    <div class="chart-container">
      <div id="price-comparison-main" class="h-[400px]">
        <p class="text-ink-400 text-sm">Loading...</p>
      </div>
    </div>
    <p class="text-sm text-ink-500 mt-4">Source: Eurostat, EIA, IEA</p>
  </div>

  <!-- Analysis section -->
  <div class="prose mb-12">
    <h2>What the data shows</h2>
    <p>
      European industrial electricity prices have <strong>consistently exceeded US and Chinese prices</strong> for over
      a decade, but the gap has widened dramatically since 2021. The energy crisis triggered by the Russia-Ukraine
      conflict exposed Europe's vulnerability to energy supply disruptions.
    </p>
    <p>
      While prices have retreated from the 2022 peak, they remain <strong>50% higher than pre-crisis levels</strong> and
      show no sign of converging with competitor regions. The structural factors driving high prices—carbon pricing,
      renewable subsidies, nuclear phase-outs, and grid constraints—remain in place.
    </p>
  </div>

  <!-- Country breakdown -->
  <div class="mb-12">
    <h2 class="text-display-sm mb-4">EU Country Breakdown ({stats.latest.year})</h2>
    <p class="text-ink-600 mb-6">Prices vary significantly across the EU. Countries with nuclear (France, Sweden) have lower prices.</p>
    <div class="chart-container">
      <div id="country-breakdown" class="h-[350px]">
        <p class="text-ink-400 text-sm">Loading...</p>
      </div>
    </div>
  </div>

  <!-- Price ratio over time -->
  <div class="mb-12">
    <h2 class="text-display-sm mb-4">EU/US Price Ratio Over Time</h2>
    <p class="text-ink-600 mb-6">The price disadvantage has grown over time, reaching {ratioDisplay}× in {stats.latest.year}.</p>
    <div class="chart-container">
      <div id="price-ratio" class="h-[300px]">
        <p class="text-ink-400 text-sm">Loading...</p>
      </div>
    </div>
  </div>

  <!-- Projections -->
  <div class="mb-12">
    <h2 class="text-display-sm mb-4">IEA Projections (Stated Policies Scenario)</h2>
    <p class="text-ink-600 mb-6">Even optimistic projections show Europe maintaining a significant price disadvantage through 2040.</p>
    <div class="chart-container">
      <div id="projections" class="h-[350px]">
        <p class="text-ink-400 text-sm">Loading...</p>
      </div>
    </div>
    <div class="mt-6 callout-warning">
      <p class="font-semibold mb-2">Important caveat</p>
      <p class="text-sm text-ink-700">
        These projections assume current policies continue. They do not account for potential policy changes
        advocated by PowerEurope. With aggressive nuclear buildout and carbon tax suspension, Europe could
        achieve price parity by 2035.
      </p>
    </div>
  </div>

  <!-- What this means -->
  <div class="bg-ink-950 text-white p-8 mb-12">
    <h2 class="text-display-sm text-white mb-6">What This Means for Europe</h2>
    <div class="grid md:grid-cols-3 gap-6">
      <div>
        <p class="text-2xl font-bold text-white mb-2">€87/MWh</p>
        <p class="text-ink-300 text-sm">
          Extra cost per MWh compared to US competitors. For an aluminum smelter using 500 GWh/year, that's
          <strong class="text-white">€43 million annually</strong> in additional energy costs.
        </p>
      </div>
      <div>
        <p class="text-2xl font-bold text-white mb-2">30-40%</p>
        <p class="text-ink-300 text-sm">
          Energy as a share of operating costs for energy-intensive industries like steel, chemicals, and aluminum.
          European plants are structurally uncompetitive.
        </p>
      </div>
      <div>
        <p class="text-2xl font-bold text-white mb-2">$100M+</p>
        <p class="text-ink-300 text-sm">
          Cost to train a frontier AI model. Energy is 30-50% of compute cost. Europe cannot build sovereign AI
          at these energy prices.
        </p>
      </div>
    </div>
  </div>

  <!-- Download data -->
  <div class="border border-ink-200 p-8 text-center">
    <p class="font-semibold mb-2">Download the Data</p>
    <p class="text-ink-600 mb-4 text-sm">
      All data is available under CC BY 4.0. Use it in your own analysis, journalism, or advocacy.
    </p>
    <div class="flex justify-center gap-4">
      <a href="/data/energy-prices.json" download class="btn btn-secondary">
        Download JSON
      </a>
      <a href="/data/energy-prices.csv" download class="btn btn-secondary">
        Download CSV
      </a>
    </div>
  </div>
</DataLayout>

<script>
  import * as Plot from '@observablehq/plot';
  import energyData from '../../data/energy-prices.json';
  import { createResponsiveChart } from '../../lib/charts';
  import {
    energyPriceColors,
    getEnergyPriceProjectionSeries,
    getEnergyPriceRatioSeries,
    getEnergyPriceSeries,
    getSortedCountryBreakdown,
  } from '../../lib/energy-prices';

  // Transform data for charts
  const timeSeriesData = getEnergyPriceSeries(energyData);
  const countryData = getSortedCountryBreakdown(energyData);
  const ratioData = getEnergyPriceRatioSeries(energyData);
  const projectionData = getEnergyPriceProjectionSeries(energyData);
  const latestYear = energyData.timeSeries[energyData.timeSeries.length - 1].year;
  const latestUsPrice = energyData.timeSeries[energyData.timeSeries.length - 1].usa;
  const projectionEndYear = energyData.projections.data[energyData.projections.data.length - 1].year;

  // Main comparison chart
  const mainContainer = document.getElementById('price-comparison-main');
  if (mainContainer) {
    createResponsiveChart(mainContainer, (width) => Plot.plot({
      width,
      height: 370,
      marginLeft: 50,
      marginRight: 90,
      marginBottom: 30,
      style: { background: 'transparent', fontSize: '11px', fontFamily: 'Inter, system-ui, sans-serif' },
      x: { label: null, tickFormat: 'd' },
      y: { label: null, grid: true, domain: [0, 200], tickFormat: d => `€${d}` },
      color: energyPriceColors,
      marks: [
        Plot.ruleY([0], { stroke: '#e3e3e3' }),
        Plot.line(timeSeriesData, { x: 'year', y: 'price', stroke: 'region', strokeWidth: d => d.region === 'Europe' ? 2.5 : 1.5 }),
        Plot.text(
          timeSeriesData.filter(d => d.year === latestYear),
          { x: 'year', y: 'price', text: 'region', dx: 6, textAnchor: 'start', fill: 'region', fontWeight: d => d.region === 'Europe' ? '600' : '400', fontSize: 11 }
        ),
      ],
    }));
  }

  // Country breakdown chart
  const countryContainer = document.getElementById('country-breakdown');
  if (countryContainer) {
    createResponsiveChart(countryContainer, (width) => Plot.plot({
      width,
      height: 320,
      marginLeft: 100,
      marginRight: 50,
      style: { background: 'transparent', fontSize: '11px', fontFamily: 'Inter, system-ui, sans-serif' },
      x: { label: null, grid: true, tickFormat: d => `€${d}` },
      y: { label: null },
      marks: [
        Plot.barX(countryData, {
          y: 'country',
          x: 'price',
          fill: '#1a1a1a',
          sort: { y: '-x' },
        }),
        Plot.text(countryData, {
          y: 'country',
          x: 'price',
          text: d => `€${d.price}`,
          dx: 5,
          textAnchor: 'start',
          fontSize: 10,
        }),
        Plot.ruleX([latestUsPrice], { stroke: '#666666', strokeDasharray: '4,4', strokeWidth: 1.5 }),
      ],
    }));
  }

  // Price ratio chart
  const ratioContainer = document.getElementById('price-ratio');
  if (ratioContainer) {
    createResponsiveChart(ratioContainer, (width) => Plot.plot({
      width,
      height: 270,
      marginLeft: 50,
      marginBottom: 30,
      style: { background: 'transparent', fontSize: '11px', fontFamily: 'Inter, system-ui, sans-serif' },
      x: { label: null, tickFormat: 'd' },
      y: { label: null, grid: true, domain: [1, 3], tickFormat: d => `${d}×` },
      marks: [
        Plot.ruleY([1], { stroke: '#e3e3e3' }),
        Plot.areaY(ratioData, { x: 'year', y: 'ratio', fill: '#1a1a1a', fillOpacity: 0.1 }),
        Plot.line(ratioData, { x: 'year', y: 'ratio', stroke: '#1a1a1a', strokeWidth: 2 }),
      ],
    }));
  }

  // Projections chart
  const projContainer = document.getElementById('projections');
  if (projContainer) {
    createResponsiveChart(projContainer, (width) => Plot.plot({
      width,
      height: 320,
      marginLeft: 50,
      marginRight: 90,
      marginBottom: 30,
      style: { background: 'transparent', fontSize: '11px', fontFamily: 'Inter, system-ui, sans-serif' },
      x: { label: null, tickFormat: 'd' },
      y: { label: null, grid: true, domain: [0, 180], tickFormat: d => `€${d}` },
      color: energyPriceColors,
      marks: [
        Plot.ruleY([0], { stroke: '#e3e3e3' }),
        Plot.line(projectionData.filter(d => d.type === 'historical'), {
          x: 'year', y: 'price', stroke: 'region', strokeWidth: d => d.region === 'Europe' ? 2.5 : 1.5
        }),
        Plot.line(projectionData.filter(d => d.type === 'projection'), {
          x: 'year', y: 'price', stroke: 'region', strokeWidth: d => d.region === 'Europe' ? 2 : 1.5, strokeDasharray: '6,4'
        }),
        Plot.text(
          projectionData.filter(d => d.year === projectionEndYear),
          { x: 'year', y: 'price', text: 'region', dx: 6, textAnchor: 'start', fill: 'region', fontWeight: d => d.region === 'Europe' ? '600' : '400', fontSize: 11 }
        ),
        Plot.ruleX([latestYear], { stroke: '#a4a4a4', strokeDasharray: '2,2' }),
      ],
    }));
  }
</script>
