---
import DataLayout from '../../layouts/DataLayout.astro';
import Chart from '../../components/Chart.astro';
import StatCard from '../../components/StatCard.astro';
import DataSource from '../../components/DataSource.astro';
import energyData from '../../data/energy-prices.json';

const sources = energyData.metadata.sources;
const lastUpdated = new Date(energyData.metadata.lastUpdated);
---

<DataLayout
  title="Industrial Electricity Prices"
  description="Track the growing gap between European energy costs and global competitors. Updated monthly with data from Eurostat, EIA, and IEA."
  lastUpdated={lastUpdated}
  sources={sources}
>
  <!-- Key stats -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-12">
    <StatCard
      value="€145"
      label="EU Average (2024)"
      change="+52% vs 2019"
      changeDirection="up"
    />
    <StatCard
      value="€58"
      label="US Average (2024)"
      change="+21% vs 2019"
      changeDirection="up"
    />
    <StatCard
      value="2.5x"
      label="EU/US Price Ratio"
      change="Up from 2.2x in 2019"
      changeDirection="up"
    />
    <StatCard
      value="€87"
      label="EU Premium vs US"
      change="Per MWh"
      changeDirection="neutral"
    />
  </div>

  <!-- Main comparison chart -->
  <div class="mb-12">
    <Chart
      id="price-comparison-main"
      title="Industrial Electricity Prices: Europe vs. US vs. China (2008-2024)"
      caption="EU industrial electricity prices have diverged sharply from competitors, especially since 2021."
      height="450px"
    />
    <div class="mt-4">
      <DataSource name="Eurostat, EIA, IEA" url="https://ec.europa.eu/eurostat" lastUpdated={lastUpdated} />
    </div>
  </div>

  <!-- Analysis section -->
  <div class="prose max-w-none mb-12">
    <h2>What the data shows</h2>
    <p>
      European industrial electricity prices have <strong>consistently exceeded US and Chinese prices</strong> for over
      a decade, but the gap has widened dramatically since 2021. The energy crisis triggered by the Russia-Ukraine
      conflict exposed Europe's vulnerability to energy supply disruptions.
    </p>
    <p>
      While prices have retreated from the 2022 peak, they remain <strong>50% higher than pre-crisis levels</strong> and
      show no sign of converging with competitor regions. The structural factors driving high prices—carbon pricing,
      renewable subsidies, nuclear phase-outs, and grid constraints—remain in place.
    </p>
  </div>

  <!-- Country breakdown -->
  <div class="mb-12">
    <h2 class="text-2xl font-bold mb-6">EU Country Breakdown (2024)</h2>
    <Chart
      id="country-breakdown"
      title=""
      caption="Prices vary significantly across the EU. Countries with nuclear (France, Sweden) have lower prices."
      height="350px"
    />
  </div>

  <!-- Price ratio over time -->
  <div class="mb-12">
    <h2 class="text-2xl font-bold mb-6">EU/US Price Ratio Over Time</h2>
    <Chart
      id="price-ratio"
      title=""
      caption="The price disadvantage has grown from 1.7x in 2010 to 2.5x in 2024."
      height="300px"
    />
  </div>

  <!-- Projections -->
  <div class="mb-12">
    <h2 class="text-2xl font-bold mb-6">IEA Projections (Stated Policies Scenario)</h2>
    <Chart
      id="projections"
      title=""
      caption="Even optimistic projections show Europe maintaining a significant price disadvantage through 2040."
      height="350px"
    />
    <div class="mt-6 p-6 bg-amber-50 rounded-xl border border-amber-200">
      <h3 class="font-semibold text-amber-900 mb-2">Important caveat</h3>
      <p class="text-amber-800 text-sm">
        These projections assume current policies continue. They do not account for potential policy changes
        advocated by PowerEurope. With aggressive nuclear buildout and carbon tax suspension, Europe could
        achieve price parity by 2035.
      </p>
    </div>
  </div>

  <!-- What this means -->
  <div class="bg-gray-900 text-white rounded-xl p-8 mb-12">
    <h2 class="text-2xl font-bold mb-6">What This Means for Europe</h2>
    <div class="grid md:grid-cols-3 gap-6">
      <div>
        <div class="text-3xl font-bold text-red-400 mb-2">€87/MWh</div>
        <p class="text-gray-300 text-sm">
          Extra cost per MWh compared to US competitors. For an aluminum smelter using 500 GWh/year, that's
          <strong class="text-white">€43 million annually</strong> in additional energy costs.
        </p>
      </div>
      <div>
        <div class="text-3xl font-bold text-red-400 mb-2">30-40%</div>
        <p class="text-gray-300 text-sm">
          Energy as a share of operating costs for energy-intensive industries like steel, chemicals, and aluminum.
          European plants are structurally uncompetitive.
        </p>
      </div>
      <div>
        <div class="text-3xl font-bold text-red-400 mb-2">$100M+</div>
        <p class="text-gray-300 text-sm">
          Cost to train a frontier AI model. Energy is 30-50% of compute cost. Europe cannot build sovereign AI
          at these energy prices.
        </p>
      </div>
    </div>
  </div>

  <!-- Download data -->
  <div class="text-center p-8 bg-gray-50 rounded-xl">
    <h3 class="text-xl font-bold mb-2">Download the Data</h3>
    <p class="text-gray-600 mb-4">
      All data is available under CC BY 4.0. Use it in your own analysis, journalism, or advocacy.
    </p>
    <div class="flex justify-center gap-4">
      <a href="/data/energy-prices.json" download class="btn btn-secondary">
        Download JSON
      </a>
      <a href="/data/energy-prices.csv" download class="btn btn-secondary">
        Download CSV
      </a>
    </div>
  </div>
</DataLayout>

<script>
  import * as Plot from '@observablehq/plot';
  import energyData from '../../data/energy-prices.json';

  // Transform data for charts
  const timeSeriesData = energyData.timeSeries.flatMap(d => [
    { year: d.year, region: 'Europe', price: d.europe },
    { year: d.year, region: 'United States', price: d.usa },
    { year: d.year, region: 'China', price: d.china },
  ]);

  const countryData = energyData.countryBreakdown2024.sort((a, b) => b.price - a.price);

  const ratioData = energyData.timeSeries.map(d => ({
    year: d.year,
    ratio: d.europe / d.usa,
  }));

  const projectionData = [
    ...energyData.timeSeries.slice(-3).flatMap(d => [
      { year: d.year, region: 'Europe', price: d.europe, type: 'historical' },
      { year: d.year, region: 'United States', price: d.usa, type: 'historical' },
      { year: d.year, region: 'China', price: d.china, type: 'historical' },
    ]),
    ...energyData.projections.data.flatMap(d => [
      { year: d.year, region: 'Europe', price: d.europe, type: 'projection' },
      { year: d.year, region: 'United States', price: d.usa, type: 'projection' },
      { year: d.year, region: 'China', price: d.china, type: 'projection' },
    ]),
  ];

  // Main comparison chart
  const mainContainer = document.getElementById('price-comparison-main');
  if (mainContainer) {
    mainContainer.innerHTML = '';
    const chart = Plot.plot({
      width: mainContainer.clientWidth,
      height: 400,
      marginLeft: 60,
      marginRight: 100,
      style: { background: 'transparent', fontSize: '12px' },
      x: { label: 'Year', tickFormat: 'd' },
      y: { label: '€/MWh', grid: true, domain: [0, 200] },
      color: {
        domain: ['Europe', 'United States', 'China'],
        range: ['#1d4ed8', '#16a34a', '#dc2626'],
      },
      marks: [
        Plot.ruleY([0]),
        Plot.line(timeSeriesData, { x: 'year', y: 'price', stroke: 'region', strokeWidth: 2.5 }),
        Plot.dot(timeSeriesData, { x: 'year', y: 'price', fill: 'region', r: 3 }),
        Plot.text(
          timeSeriesData.filter(d => d.year === 2024),
          { x: 'year', y: 'price', text: 'region', dx: 10, textAnchor: 'start', fill: 'region', fontWeight: 'bold' }
        ),
      ],
    });
    mainContainer.appendChild(chart);
  }

  // Country breakdown chart
  const countryContainer = document.getElementById('country-breakdown');
  if (countryContainer) {
    countryContainer.innerHTML = '';
    const chart = Plot.plot({
      width: countryContainer.clientWidth,
      height: 300,
      marginLeft: 120,
      marginRight: 60,
      style: { background: 'transparent', fontSize: '12px' },
      x: { label: '€/MWh', grid: true },
      y: { label: null },
      marks: [
        Plot.barX(countryData, {
          y: 'country',
          x: 'price',
          fill: d => d.price > 150 ? '#dc2626' : d.price > 130 ? '#f59e0b' : '#16a34a',
          sort: { y: '-x' },
        }),
        Plot.text(countryData, {
          y: 'country',
          x: 'price',
          text: d => `€${d.price}`,
          dx: 5,
          textAnchor: 'start',
          fontSize: 11,
        }),
        Plot.ruleX([58], { stroke: '#16a34a', strokeDasharray: '4,4', strokeWidth: 2 }),
        Plot.text([{ x: 58, label: 'US Average' }], {
          x: 'x',
          text: 'label',
          dy: -140,
          dx: 5,
          textAnchor: 'start',
          fill: '#16a34a',
          fontSize: 10,
        }),
      ],
    });
    countryContainer.appendChild(chart);
  }

  // Price ratio chart
  const ratioContainer = document.getElementById('price-ratio');
  if (ratioContainer) {
    ratioContainer.innerHTML = '';
    const chart = Plot.plot({
      width: ratioContainer.clientWidth,
      height: 250,
      marginLeft: 60,
      style: { background: 'transparent', fontSize: '12px' },
      x: { label: 'Year', tickFormat: 'd' },
      y: { label: 'EU/US Ratio', grid: true, domain: [1, 3] },
      marks: [
        Plot.ruleY([1], { stroke: '#ccc' }),
        Plot.areaY(ratioData, { x: 'year', y: 'ratio', fill: '#1d4ed8', fillOpacity: 0.1 }),
        Plot.line(ratioData, { x: 'year', y: 'ratio', stroke: '#1d4ed8', strokeWidth: 2.5 }),
        Plot.dot(ratioData, { x: 'year', y: 'ratio', fill: '#1d4ed8', r: 4 }),
      ],
    });
    ratioContainer.appendChild(chart);
  }

  // Projections chart
  const projContainer = document.getElementById('projections');
  if (projContainer) {
    projContainer.innerHTML = '';
    const chart = Plot.plot({
      width: projContainer.clientWidth,
      height: 300,
      marginLeft: 60,
      marginRight: 100,
      style: { background: 'transparent', fontSize: '12px' },
      x: { label: 'Year', tickFormat: 'd' },
      y: { label: '€/MWh', grid: true, domain: [0, 180] },
      color: {
        domain: ['Europe', 'United States', 'China'],
        range: ['#1d4ed8', '#16a34a', '#dc2626'],
      },
      marks: [
        Plot.line(projectionData.filter(d => d.type === 'historical'), {
          x: 'year', y: 'price', stroke: 'region', strokeWidth: 2.5
        }),
        Plot.line(projectionData.filter(d => d.type === 'projection'), {
          x: 'year', y: 'price', stroke: 'region', strokeWidth: 2, strokeDasharray: '6,4'
        }),
        Plot.dot(projectionData, { x: 'year', y: 'price', fill: 'region', r: 3 }),
        Plot.text(
          projectionData.filter(d => d.year === 2040),
          { x: 'year', y: 'price', text: 'region', dx: 10, textAnchor: 'start', fill: 'region', fontWeight: 'bold' }
        ),
        Plot.ruleX([2024], { stroke: '#999', strokeDasharray: '2,2' }),
      ],
    });
    projContainer.appendChild(chart);
  }
</script>
